<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Toast Talent</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    body { font-family: system-ui, sans-serif; background:#f6f6f6; }
    .admin-container { max-width: 680px; margin: 36px auto; padding: 22px; background:#fff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.05); }
    label { display:block; margin-top:12px; font-weight:600; }
    input, textarea, select { width:100%; padding:10px; margin-top:6px; border:1px solid #ddd; border-radius:8px; font-size:15px; }
    button { margin-top:12px; padding:12px 18px; background:#111; color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:15px; }
    button[disabled] { background:#999; cursor:not-allowed; }
    .error { color:#c0392b; margin-top:8px; font-weight:500; }
    .success { color:green; margin-top:8px; font-weight:500; }
  </style>
</head>
<body>
  <div class="admin-container">
    <h1>Admin — Toast Talent</h1>

    <section id="loginSection">
      <h2>Admin login</h2>
      <form id="loginForm">
        <label>Passcode</label>
        <input id="adminPass" type="password" required autocomplete="current-password" />
        <button type="submit" id="loginBtn">Unlock Admin</button>
        <div id="loginError" class="error"></div>
      </form>
    </section>

    <section id="panel" style="display:none;">
      <h2>Submit Model</h2>
      <form id="modelForm">
        <label for="name">Name</label>
        <input id="name" name="name" required />

        <label for="age">Age</label>
        <input id="age" name="age" type="number" />

        <label for="bio">Bio</label>
        <textarea id="bio" name="bio"></textarea>

        <label for="images">Images (comma-separated URLs)</label>
        <input id="images" name="images" placeholder="https://... , https://..." />

        <button type="submit" id="submitBtn">Submit Model</button>
        <div id="submitError" class="error"></div>
        <div id="submitSuccess" class="success"></div>
      </form>

      <button id="logoutBtn" style="background:#777;">Logout</button>
    </section>
  </div>

<script>
  // Dynamically detect correct API base
  const API_BASE = (() => {
    const host = window.location.hostname;
    if (host.includes('toasttalent.co.za')) return 'https://api.toasttalent.co.za';
    if (host.includes('onrender.com')) return 'https://toast-talent-modeling-agency.onrender.com';
    return 'http://localhost:10000'; // local dev
  })();

  const loginForm = document.getElementById('loginForm');
  const loginError = document.getElementById('loginError');
  const adminPass = document.getElementById('adminPass');
  const panel = document.getElementById('panel');
  const loginSection = document.getElementById('loginSection');
  const loginBtn = document.getElementById('loginBtn');

  // LOGIN
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    loginError.textContent = '';
    loginBtn.disabled = true;
    loginBtn.textContent = 'Logging in...';
    try {
      const res = await fetch(`${API_BASE}/api/admin-login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ password: adminPass.value.trim() })
      });

      const json = await res.json();
      if (res.ok && json.ok) {
        loginSection.style.display = 'none';
        panel.style.display = 'block';
      } else {
        loginError.textContent = json.message || 'Incorrect password';
        adminPass.value = '';
        adminPass.focus();
      }
    } catch (err) {
      console.error('Login error', err);
      loginError.textContent = 'Network error during login.';
    } finally {
      loginBtn.disabled = false;
      loginBtn.textContent = 'Unlock Admin';
    }
  });

  // SUBMIT MODEL
  const modelForm = document.getElementById('modelForm');
  const submitError = document.getElementById('submitError');
  const submitSuccess = document.getElementById('submitSuccess');
  const submitBtn = document.getElementById('submitBtn');

  modelForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    submitError.textContent = '';
    submitSuccess.textContent = '';
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    const payload = {
      name: document.getElementById('name').value.trim(),
      age: Number(document.getElementById('age').value) || undefined,
      bio: document.getElementById('bio').value.trim(),
      images: (document.getElementById('images').value || '')
        .split(',')
        .map(s => s.trim())
        .filter(Boolean)
    };

    try {
      const res = await fetch(`${API_BASE}/api/models`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        const created = await res.json();
        submitSuccess.textContent = `✅ Model created successfully: ${created.name || created._id || ''}`;
        modelForm.reset();
      } else if (res.status === 401) {
        submitError.textContent = 'You are not authorized. Please log in again.';
        panel.style.display = 'none';
        loginSection.style.display = 'block';
      } else {
        const txt = await res.text().catch(()=> '');
        submitError.textContent = `Submission failed: ${res.status} ${res.statusText} ${txt}`;
      }
    } catch (err) {
      console.error('Submit error', err);
      submitError.textContent = 'Network error while submitting model.';
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Model';
    }
  });

  // LOGOUT
  document.getElementById('logoutBtn').addEventListener('click', () => {
    panel.style.display = 'none';
    loginSection.style.display = 'block';
    adminPass.value = '';
  });
</script>
</body>
</html>
